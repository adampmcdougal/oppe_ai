// Prisma schema for OPPE AI system
// Database: PostgreSQL
// Purpose: Track physician performance and clinical competence

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(PHYSICIAN)
  specialty     String?
  npi           String?   @unique // National Provider Identifier
  licenseNumber String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  cases         Case[]    @relation("PhysicianCases")
  reviews       Review[]  @relation("ReviewerReviews")
  competencies  PhysicianCompetency[]
  alerts        Alert[]
  
  @@index([email])
  @@index([npi])
}

enum UserRole {
  PHYSICIAN
  PEER_REVIEWER
  DEPARTMENT_HEAD
  ADMINISTRATOR
}

// Case tracking
model Case {
  id              String      @id @default(cuid())
  physicianId     String
  patientMRN      String      // Medical Record Number (encrypted/hashed)
  caseType        CaseType
  procedureCode   String?
  diagnosis       String?
  outcome         CaseOutcome
  complications   String?
  date            DateTime
  reviewStatus    ReviewStatus @default(PENDING)
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  physician       User        @relation("PhysicianCases", fields: [physicianId], references: [id])
  reviews         Review[]
  
  @@index([physicianId])
  @@index([date])
  @@index([reviewStatus])
}

enum CaseType {
  SURGICAL
  MEDICAL
  PROCEDURAL
  CONSULTATION
  EMERGENCY
}

enum CaseOutcome {
  EXCELLENT
  GOOD
  ACCEPTABLE
  POOR
  ADVERSE_EVENT
}

enum ReviewStatus {
  PENDING
  IN_REVIEW
  COMPLETED
  FLAGGED
}

// Competency tracking
model Competency {
  id              String    @id @default(cuid())
  name            String    @unique
  description     String
  category        CompetencyCategory
  minimumScore    Float     @default(70.0)
  createdAt       DateTime  @default(now())
  
  // Relations
  physicianCompetencies PhysicianCompetency[]
}

enum CompetencyCategory {
  PATIENT_CARE
  MEDICAL_KNOWLEDGE
  PRACTICE_BASED_LEARNING
  INTERPERSONAL_SKILLS
  PROFESSIONALISM
  SYSTEMS_BASED_PRACTICE
}

// Physician competency scores
model PhysicianCompetency {
  id              String      @id @default(cuid())
  physicianId     String
  competencyId    String
  score           Float
  assessmentDate  DateTime
  notes           String?
  createdAt       DateTime    @default(now())
  
  // Relations
  physician       User        @relation(fields: [physicianId], references: [id])
  competency      Competency  @relation(fields: [competencyId], references: [id])
  
  @@unique([physicianId, competencyId, assessmentDate])
  @@index([physicianId])
  @@index([assessmentDate])
}

// Peer reviews
model Review {
  id              String      @id @default(cuid())
  caseId          String
  reviewerId      String
  rating          Int         // 1-5 scale
  technicalSkill  Int?        // 1-5 scale
  judgment        Int?        // 1-5 scale
  communication   Int?        // 1-5 scale
  professionalism Int?        // 1-5 scale
  comments        String?
  concerns        String?
  reviewDate      DateTime    @default(now())
  createdAt       DateTime    @default(now())
  
  // Relations
  case            Case        @relation(fields: [caseId], references: [id])
  reviewer        User        @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  
  @@index([caseId])
  @@index([reviewerId])
}

// Performance alerts
model Alert {
  id              String      @id @default(cuid())
  physicianId     String
  severity        AlertSeverity
  type            AlertType
  message         String
  details         String?
  acknowledged    Boolean     @default(false)
  acknowledgedAt  DateTime?
  createdAt       DateTime    @default(now())
  
  // Relations
  physician       User        @relation(fields: [physicianId], references: [id])
  
  @@index([physicianId])
  @@index([acknowledged])
  @@index([createdAt])
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertType {
  LOW_COMPETENCY_SCORE
  HIGH_COMPLICATION_RATE
  PEER_REVIEW_CONCERN
  PATTERN_DEVIATION
  MISSING_DATA
}
